---

name: Build Docker Image

# Controls when the workflow will run
on:
    push:
        branches:
            - "production"
            - "staging"
        tags:
            - "v*.*.*"
    pull_request:
        branches:
            - "production"
            - "staging"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
        # Get the repository's code
        - name: Checkout
          uses: actions/checkout@v2
    
        # https://github.com/docker/setup-qemu-action
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v3
    
          # https://github.com/docker/setup-buildx-action
        - name: Set up Docker Buildx
          id: buildx
          uses: docker/setup-buildx-action@v3

        # Login to Azure Container Registry
        - name: Login to ACR
          if: github.event_name != 'pull_request'
          uses: azure/docker-login@v2
          with:
            login-server: ${{ secrets.ACR_LOGIN_SERVER }}
            username: ${{ secrets.ACR_USERNAME }}
            password: ${{ secrets.ACR_PASSWORD }}

        # Build Docker image
        - name: Docker meta
          id: id
          uses: docker/metadata-action@v3
          with:
            # list of Docker images to use as base name for tags
            images: |
                ${{ secrets.ACR_LOGIN_SERVER }}/${{ github.event.repository.name }}
            
            # Docker tags based on the following events/attributes
            tags: |
                type=schedule
                type=ref,event=branch
                type=ref,event=pr
                type=semver,pattern={{version}}
                type=semver,pattern={{major}}.{{minor}}
                type=semver,pattern={{major}}
                type=sha

        - name: Build and push
          uses: docker/build-push-action@v6
          with:
            context: .
            platforms: linux/amd64,linux/arm64
            push: ${{ github.event_name != 'pull_request' }}
            tags: ${{ steps.id.outputs.tags }}
            labels: ${{ steps.id.outputs.labels }}